# Validate the structure of a container image
# See https://github.com/GoogleContainerTools/container-structure-test
schemaVersion: 2.0.0

# Metadata test ensures the container is configured correctly
metadataTest:

  # List of image labels key/value pairs that should be set on the container
  labels:

    - key: maintainer
      value: Lally Elias <lallyelias87@gmail.com>

    - key: vendor
      value: lykmapipo

  # List of environment variable key/value pairs that should be set in the container
  envVars:

    - key: LANG
      value: en_US.UTF-8

    - key: LC_ALL
      value: en_US.UTF-8

    - key: USER_UID
      value: 1000

    - key: USER_GID
      value: 1000

    - key: DEBIAN_FRONTEND
      value: noninteractive

    - key: USER_NAME
      value: ubuntu

    - key: USER_GROUP
      value: ubuntu

    - key: DEBIAN_FRONTEND
      value: noninteractive

    - key: LANGUAGE
      value: en_US:en

    - key: TZ
      value: UTC

  # CMD specified in the container
  cmd: [bash]


# Ensure that certain commands run properly in the target image
commandTests:

  - name: apt installed
    command: which
    args: [apt]
    expectedOutput: [/usr/bin/apt]

  - name: bzip2 installed
    command: which
    args: [bzip2]
    expectedOutput: [/usr/bin/bzip2]

  - name: bunzip2 installed
    command: which
    args: [bunzip2]
    expectedOutput: [/usr/bin/bunzip2]

  - name: curl installed
    command: which
    args: [curl]
    expectedOutput: [/usr/bin/curl]

  - name: gzip installed
    command: which
    args: [gzip]
    expectedOutput: [/usr/bin/gzip]

  - name: gunzip installed
    command: which
    args: [gunzip]
    expectedOutput: [/usr/bin/gunzip]

  - name: gnupg installed
    command: which
    args: [gpg]
    expectedOutput: [/usr/bin/gpg]

  - name: jq installed
    command: which
    args: [jq]
    expectedOutput: [/usr/bin/jq]

  - name: less installed
    command: which
    args: [less]
    expectedOutput: [/usr/bin/less]

  - name: openssl installed
    command: which
    args: [openssl]
    expectedOutput: [/usr/bin/openssl]

  - name: rar installed
    command: which
    args: [rar]
    expectedOutput: [/usr/bin/rar]

  - name: unrar installed
    command: which
    args: [unrar]
    expectedOutput: [/usr/bin/unrar]

  - name: sudo installed
    command: which
    args: [sudo]
    expectedOutput: [/usr/bin/sudo]

  - name: tar installed
    command: which
    args: [tar]
    expectedOutput: [/usr/bin/tar]

  - name: unrar installed
    command: which
    args: [unrar]
    expectedOutput: [/usr/bin/unrar]

  - name: wget installed
    command: which
    args: [wget]
    expectedOutput: [/usr/bin/wget]

  - name: zip installed
    command: which
    args: [zip]
    expectedOutput: [/usr/bin/zip]

  - name: unzip installed
    command: which
    args: [unzip]
    expectedOutput: [/usr/bin/unzip]

  - name: ubuntu user exists
    command: bash
    args:
      - -c
      - |
          if id "ubuntu" &>/dev/null; then
            echo "'ubuntu' user exists."
          else
            echo "'ubuntu' user does not exist."
            exit 1
          fi


# Check to make sure a specific file (or directory) exist within the file system of the image
fileExistenceTests:

  - name: etc/sudoers
    path: etc/sudoers
    shouldExist: true
    permissions: -r--r-----
    uid: 0
    gid: 0

  - name: etc/sudoers.d
    path: etc/sudoers.d
    shouldExist: true
    permissions: drwxr-xr-x
    uid: 0
    gid: 0

  - name: etc/ssl/certs
    path: etc/ssl/certs
    shouldExist: true
    permissions: drwxr-xr-x
    uid: 0
    gid: 0

  - name: etc/locale.gen
    path: etc/locale.gen
    shouldExist: true
    permissions: -rw-r--r--
    uid: 0
    gid: 0

  - name: usr/share/locale/locale.alias
    path: usr/share/locale/locale.alias
    shouldExist: true
    # permissions: -rw-r--r-- ???
    uid: 0
    gid: 0

  - name: home/ubuntu
    path: home/ubuntu
    shouldExist: true
    permissions: drwxr-x---
    uid: 1000
    gid: 1000

  - name: etc/sudoers.d/ubuntu
    path: etc/sudoers.d/ubuntu
    shouldExist: true
    permissions: -r--r-----
    uid: 0
    gid: 0
